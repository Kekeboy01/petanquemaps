<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Carte des terrains de p√©tanque</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }

    #map {
      height: 80vh;
      width: 100%;
    }

    #formulaire {
      padding: 10px;
      background: #f0f0f0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    #formulaire input,
    #formulaire select,
    #formulaire button {
      padding: 5px;
    }

    #filtre-container {
      width: 100%;
      margin-top: 10px;
    }

    .popup-btn {
      margin-top: 5px;
      display: inline-block;
      background-color: #e74c3c;
      color: white;
      padding: 3px 6px;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<!-- Formulaire -->
<div id="formulaire">
  <strong>‚ûï Ajouter</strong>
  <select id="type-ajout" onchange="switchFormType()">
    <option value="terrain">un terrain</option>
    <option value="club">un club</option>
  </select>
  <!-- Nom terrain -->
  <input id="name-terrain" placeholder="Nom du terrain" />
  <!-- Nom club -->
  <input id="name-club" placeholder="Nom du club" class="hidden" />
  <select id="region">
    <option>Bruxelles</option>
    <option>Wallonie</option>
    <option>Flandre</option>
  </select>
  <select id="rating">
    <option value="1">‚≠ê</option>
    <option value="2">‚≠ê‚≠ê</option>
    <option value="3">‚≠ê‚≠ê‚≠ê</option>
    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
  </select>
  <input id="adresse" placeholder="Adresse" />
  <input id="lat" placeholder="Latitude" />
  <input id="lng" placeholder="Longitude" />
  <button onclick="addLieu()">Ajouter</button>

  <!-- Filtres -->
  <div id="filtre-container">
    <strong>üîç Filtrer les terrains</strong>
    <select id="filtre-region">
      <option value="">Toutes les r√©gions</option>
      <option>Bruxelles</option>
      <option>Wallonie</option>
      <option>Flandre</option>
    </select>

    <select id="filtre-note">
      <option value="">Toutes les notes</option>
      <option value="1">‚â• 1 ‚≠ê</option>
      <option value="2">‚â• 2 ‚≠ê</option>
      <option value="3">‚â• 3 ‚≠ê</option>
      <option value="4">‚â• 4 ‚≠ê</option>
      <option value="5">5 ‚≠ê</option>
    </select>

    <button onclick="appliquerFiltres()">Filtrer</button>
  </div>
</div>

<!-- Carte -->
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBuVhNOiL1B3NRJrhE7b3NhT9-gL2L-0rE",
    authDomain: "petanque-map.firebaseapp.com",
    projectId: "petanque-map",
    storageBucket: "petanque-map.appspot.com",
    messagingSenderId: "806898855194",
    appId: "1:806898855194:web:6c49fa2f54eb68697bd0a3",
    measurementId: "G-LG9ZJ3ZTNJ"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<script>
  // Changement dynamique du formulaire
  function switchFormType() {
    const type = document.getElementById("type-ajout").value;
    document.getElementById("name-terrain").classList.toggle("hidden", type !== "terrain");
    document.getElementById("name-club").classList.toggle("hidden", type !== "club");
    document.getElementById("adresse").placeholder = (type === "terrain") ? "Adresse du terrain" : "Adresse du club";
  }

  // Initialisation carte
  const map = L.map('map').setView([50.5, 4.5], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  let markers = [];

  function addLieu() {
    const type = document.getElementById("type-ajout").value;
    const name = type === "terrain" 
      ? document.getElementById("name-terrain").value 
      : document.getElementById("name-club").value;
    const region = document.getElementById("region").value;
    const rating = parseInt(document.getElementById("rating").value);
    const lat = parseFloat(document.getElementById("lat").value);
    const lng = parseFloat(document.getElementById("lng").value);
    const adresse = document.getElementById("adresse").value;

    if (!name || isNaN(lat) || isNaN(lng) || !adresse) {
      alert("‚ö†Ô∏è Veuillez remplir tous les champs correctement.");
      return;
    }

    db.collection("lieux").add({ 
      type, name, region, rating, lat, lng, adresse 
    })
      .then(() => {
        alert("‚úÖ Ajout r√©ussi !");
      })
      .catch(error => {
        console.error("Erreur d'ajout :", error);
        alert("‚ùå Erreur lors de l'ajout !");
      });
  }

  map.on("click", function(e) {
    document.getElementById("lat").value = e.latlng.lat.toFixed(6);
    document.getElementById("lng").value = e.latlng.lng.toFixed(6);
  });

  // Temps r√©el
  db.collection("lieux").onSnapshot(snapshot => {
    const lieux = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    afficherLieux(lieux);
  });

  function appliquerFiltres() {
    const region = document.getElementById("filtre-region").value;
    const noteMin = parseInt(document.getElementById("filtre-note").value);

    db.collection("lieux").get().then(snapshot => {
      const filtres = snapshot.docs
        .map(doc => ({ id: doc.id, ...doc.data() }))
        .filter(data => {
          const matchRegion = region === "" || data.region === region;
          const matchNote = isNaN(noteMin) || data.rating >= noteMin;
          return matchRegion && matchNote;
        });

      afficherLieux(filtres);
    });
  }

  function afficherLieux(lieux) {
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    lieux.sort((a, b) => b.rating - a.rating);

    lieux.forEach(data => {
      const marker = L.marker([data.lat, data.lng]).addTo(map);
      let typeLabel = data.type === "club" ? "Club" : "Terrain";
      const popup = `
        <strong>${typeLabel} : ${data.name}</strong><br>
        ${data.region}<br>
        Note : ${data.rating} ‚≠ê<br>
        Adresse : ${data.adresse}<br>
        <div class="popup-btn" onclick="supprimerLieu('${data.id}')">üóë Supprimer</div>
      `;
      marker.bindPopup(popup);
      markers.push(marker);
    });
  }

  function supprimerLieu(id) {
    if (confirm("Supprimer ce lieu ?")) {
      db.collection("lieux").doc(id).delete()
        .then(() => alert("‚úÖ Lieu supprim√©"))
        .catch(error => alert("‚ùå Erreur : " + error));
    }
  }

  // Appel au chargement pour adapter l'affichage du formulaire
  document.addEventListener('DOMContentLoaded', switchFormType);
</script>

</body>
</html>
